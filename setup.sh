#!/bin/bash

# Cfg
DBUSER=root
DBPASSWD=root

# Parse options

echo -e "\n=== Provisioning virtual machine ===\n"
sudo -s

function setHostname {

	sudo sed -i "s/contrib-jessie/$1/g" /etc/hosts
	hostname $1
	> /etc/hostname
	sudo echo $1 >> /etc/hostname
	sudo /etc/init.d/hostname.sh start
}

function updateRepositories {

	echo 'deb http://packages.dotdeb.org jessie all' >> /etc/apt/sources.list
	echo 'deb-src http://packages.dotdeb.org jessie all' >> /etc/apt/sources.list

	apt-get -y --force-yes install apt-transport-https lsb-release ca-certificates
	wget -O /etc/apt/trusted.gpg.d/php.gpg https://packages.sury.org/php/apt.gpg
	echo "deb https://packages.sury.org/php/ $(lsb_release -sc) main" > /etc/apt/sources.list.d/php.list

	sudo apt-get update
}

function installPHP {

	# Install PHP7
	echo -e "\n=== installing PHP7 & Apache2 ===\n"
	sudo apt-get -y --force-yes install php7.1 php7.1-fpm php7.1-gd php7.1-tidy php7.1-mbstring php7.1-mysql php7.1-soap php7.1-imagick php7.1-curl php7.1-zip libapache2-mod-php7.1 php7.1-xml php7.1-simplexml
}

function installApache {

	echo -e "\n=== installing Apache2 ===\n"
	sudo apt-get -y --force-yes install apache2
}

function installMySQL {

	echo -e "\n=== installing MySQL ===\n"
	debconf-set-selections <<< "mysql-server mysql-server/root_password password $DBPASSWD"
	debconf-set-selections <<< "mysql-server mysql-server/root_password_again password $DBPASSWD"
	apt-get -y --force-yes install mysql-server
}

function configureApache {

	sed -i "s/AllowOverride None/AllowOverride All/g" /etc/apache2/apache2.conf

	echo -e "\n=== Enabling mod rewrite ===\n"
	a2enmod rewrite
	echo -e "\n=== Enabling expires active ===\n"
	a2enmod expires

	echo -e "\n=== Setting document root to public directory ===\n"
	rm -rf /var/www/html
	ln -fs /home/vagrant /var/www/html
}

function configurePhp {

	sed -i "s/error_reporting = .*/error_reporting = E_ALL/" /etc/php/7.1/apache2/php.ini
	sed -i "s/display_errors = .*/display_errors = On/" /etc/php/7.1/apache2/php.ini
	sed -i "/upload_max_filesize/s/= *2M/=20M/" /etc/php/7.1/apache2/php.ini
	sudo echo 'date.timezone = "Europe/Brussels"' >> /etc/php/7.1/apache2/php.ini
}

function restartApache {
	echo -e "\n=== Restart apache ===\n"
	sudo service apache2 restart
}

function installComposer {
	cd /home/vagrant
	php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
	php -r "if (hash_file('SHA384', 'composer-setup.php') === '669656bab3166a7aff8a7506b8cb2d1c292f042046c5a994c43155c0be6190fa0355160742ab2e1c88d40d5be660b410') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"
	php composer-setup.php --filename=composer
	php -r "unlink('composer-setup.php');"
	cd /home/vagrant/default
	../composer install
}

function installAdminer {

	echo -e "\n=== Installing adminer ===\n"
	cd /home/vagrant
	mkdir adminer 2> /dev/null || echo > /dev/null
	cd adminer
	wget -O index.php https://github.com/vrana/adminer/releases/download/v4.3.0/adminer-4.3.0-mysql-en.php
	wget -O adminer.css https://raw.githubusercontent.com/vrana/adminer/master/designs/pepa-linha/adminer.css
}

setHostname "development"
updateRepositories
installApache
installPHP
installMySQL
configureApache
configurePhp
restartApache
installComposer
installAdminer